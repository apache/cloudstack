# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
---
default_stages: [pre-commit, pre-push]
default_language_version:
  # force all unspecified Python hooks to run python3
  python: python3
minimum_pre_commit_version: "3.2.0"
repos:
  - repo: meta
    hooks:
      - id: identity
        description: a simple hook which prints all arguments passed to it, useful for debugging.
      - id: check-hooks-apply
        description: check that all the hooks apply to the repository
  - repo: https://github.com/thlorenz/doctoc.git
    rev: v2.2.0
    hooks:
      - id: doctoc
        name: Add TOC for Markdown files
        description: automatically keeps your table of contents up to date
        files: ^CONTRIBUTING\.md$|^INSTALL\.md$|^README\.md$
  - repo: local
    hooks:
      - id: create-pre-commit-docs
        name: create pre-commit docs
        description: creates a Markdown file with information on the pre-commit hooks
        entry: .github/workflows/scripts/create_pre_commit_docs.py
        language: python
        additional_dependencies:
          - pyyaml
        require_serial: true
  - repo: https://github.com/oxipng/oxipng
    rev: v9.1.5
    hooks:
      - id: oxipng
        name: run oxipng
        description: optimize PNG images with lossless compression
        args: ['-o', '4', '--strip', 'safe', '--alpha']
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.27.2
    hooks:
      - id: gitleaks
        name: run gitleaks
        description: detect hardcoded secrets
  - repo: https://github.com/Lucas-C/pre-commit-hooks
    rev: v1.5.5
    hooks:
      - id: chmod
        name: set file permissions
        description: manual hook to be run by macOS or Linux users for a full repository clean up
        args: ['644']
        files: \.md$
        stages: [manual]
      - id: insert-license
        name: add license for all Markdown files
        description: automatically adds a licence header to all Markdown files that don't have a license header
        files: \.md$
        args:
          - --comment-style
          - '<!--|| -->'
          - --license-filepath
          - .github/workflows/license-templates/LICENSE.txt
          - --fuzzy-match-generates-todo
        exclude: ^(CHANGES|ISSUE_TEMPLATE|PULL_REQUEST_TEMPLATE)\.md$|^ui/docs/(full|smoke)-test-plan\.template\.md$
      - id: insert-license
        name: add license for all Shell files
        description: automatically adds a licence header to all Shell files that don't have a license header
        files: \.sh$
        args:
          - --comment-style
          - '|#|'
          - --license-filepath
          - .github/workflows/license-templates/LICENSE.txt
          - --fuzzy-match-generates-todo
      - id: insert-license
        name: add license for all SQL files
        description: automatically adds a licence header to all SQL files that don't have a license header
        files: \.sql$
        args:
          - --comment-style
          - '|--|'
          - --license-filepath
          - .github/workflows/license-templates/LICENSE.txt
          - --fuzzy-match-generates-todo
      - id: insert-license
        name: add license for all Vue files
        files: \.vue$
        args:
          - --comment-style
          - '|//|'
          - --license-filepath
          - .github/workflows/license-templates/LICENSE.txt
          - --fuzzy-match-generates-todo
      - id: insert-license
        name: add license for all YAML files
        description: automatically adds a licence header to all YAML files that don't have a license header
        files: \.ya?ml$
        args:
          - --comment-style
          - '|#|'
          - --license-filepath
          - .github/workflows/license-templates/LICENSE.txt
          - --fuzzy-match-generates-todo
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      #- id: check-added-large-files
      - id: check-case-conflict
        description: check for case conflicts in file names
      #- id: check-executables-have-shebangs
      - id: check-illegal-windows-names
        description: check for Windows-illegal file names
      - id: check-merge-conflict
        description: check for merge conflict markers
      - id: check-shebang-scripts-are-executable
        description: check that scripts with shebangs are executable
        files: \.sh$
      - id: check-symlinks
        description: checks for symlinks which do not point to anything.
      - id: check-vcs-permalinks
        description: ensures that links to vcs websites are permalinks
      #- id: check-yaml
      - id: destroyed-symlinks
        description: detects symlinks which are changed to regular files with a content of a path which that symlink was pointing to
      - id: detect-aws-credentials
        description: checks for the existence of AWS secrets that you have set up with the AWS CLI
        args: [--allow-missing-credentials]
      - id: detect-private-key
        description: checks for the existence of private keys
        exclude: >
          (?x)
          ^scripts/vm/systemvm/id_rsa\.cloud$|
          ^server/src/test/java/org/apache/cloudstack/network/ssl/CertServiceTest\.java$|
          ^server/src/test/java/com/cloud/keystore/KeystoreTest\.java$|
          ^server/src/test/resources/certs/dsa_self_signed\.key$|
          ^server/src/test/resources/certs/non_root\.key$|
          ^server/src/test/resources/certs/root_chain\.key$|
          ^server/src/test/resources/certs/rsa_ca_signed\.key$|
          ^server/src/test/resources/certs/rsa_self_signed_with_pwd\.key$|
          ^server/src/test/resources/certs/rsa_self_signed\.key$|
          ^services/console-proxy/rdpconsole/src/test/doc/rdp-key\.pem$|
          ^systemvm/agent/certs/localhost\.key$|
          ^systemvm/agent/certs/realhostip\.key$|
          ^test/integration/smoke/test_ssl_offloading\.py$
      - id: end-of-file-fixer
        description: makes sure files end in a newline and only a newline
        exclude: \.vhd$|\.svg$
      - id: file-contents-sorter
        description: sort the lines in specified files (defaults to alphabetical)
        args: [--unique]
        files: ^\.github/linters/codespell\.txt$
      - id: fix-byte-order-marker
        description: removes UTF-8 byte order marker
      - id: forbid-submodules
        description: forbids any submodules in the repository
      - id: mixed-line-ending
        description: replaces or checks mixed line ending
      - id: trailing-whitespace
        description: trims trailing whitespace
        files: \.(bat|cfg|cs|css|gitignore|header|in|install|java|md|properties|py|rb|rc|sh|sql|te|template|txt|ucls|vue|xml|xsl|yaml|yml)$|^cloud-cli/bindir/cloud-tool$|^debian/changelog$
        args: [--markdown-linebreak-ext=md]
        exclude: ^services/console-proxy/rdpconsole/src/test/doc/freerdp-debug-log\.txt$
  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        name: run codespell
        description: Check spelling with codespell
        args: [--ignore-words=.github/linters/codespell.txt]
        exclude: ^systemvm/agent/noVNC/|^ui/package\.json$|^ui/package-lock\.json$|^ui/public/js/less\.min\.js$|^ui/public/locales/.*[^n].*\.json$|^server/src/test/java/org/apache/cloudstack/network/ssl/CertServiceTest.java$|^test/integration/smoke/test_ssl_offloading.py$
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
    - id: flake8
      description: flake8 is a Python tool that glues together pycodestyle, pyflakes, mccabe, and third-party plugins to check the style and quality of some python code
      args: [--config, .github/linters/.flake8]
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.45.0
    hooks:
      - id: markdownlint
        name: run markdownlint
        description: check Markdown files with markdownlint
        args: [--config=.github/linters/.markdown-lint.yml]
        types: [markdown]
        files: \.(md|mdown|markdown)$
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: run yamllint
        description: check YAML files with yamllint
        args: [--config-file=.github/linters/.yamllint.yml]
        types: [yaml]
        files: \.ya?ml$
        exclude: ^.*k8s-.*\.ya?ml$
